name: build

inputs:
  target:
    type:     string
    required: true
  toolchain:
    type:     string
    required: false
    default:  stable

outputs:
  artifact:
    value: ${{ steps.binary.outputs.artifact }}
  executable:
    value: ${{ steps.binary.outputs.executable }}

runs:
  using: composite
  steps:
    - uses: actions-rs/toolchain@v1
      with:
        profile: minimal
        toolchain: ${{ inputs.toolchain }}
        target: ${{ inputs.target }}
    - uses: actions-rs/cargo@v1
      with:
        command: build
        use-cross: ${{ contains(inputs.target, 'musl') }}
        args: --release --target ${{ inputs.target }}
    - run:   node $GITHUB_ACTION_PATH/binary.mjs ${{ inputs.target }}
      id:    binary
      shell: bash
    - uses: actions/upload-artifact@v3
      with:
        name: ${{ steps.binary.outputs.artifact }}
        path: target/${{ inputs.target }}/release/${{ steps.binary.outputs.executable }}
